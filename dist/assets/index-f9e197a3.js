import{e as re,F as I,r as _,ai as oe,j as e,y as q,$ as p,a4 as m,aj as ce,bU as le,D as ie,A as de,al as J,S as me,B as Y,ak as ue,M as xe,u as $,am as ye,h as Q,l as k,ay as F,T as D,H as L,n as V,G as R,O as H,ap as U,cr as he,J as je,t as fe,aw as ge,ax as _e,aa as W,f as pe,I as X,P as Ae,p as be,o as Z,cf as Ee,i as Ce,v as Te,cs as De,z as Ie}from"./index-4b3d7bc8.js";import{A as ke}from"./index-d9b76a87.js";import{A as ee}from"./AccessDenied-45b92511.js";import{A as ne}from"./ActionMenu-149e95aa.js";import{T as ve}from"./Table-9972bb2a.js";import{u as O}from"./usePermissions-36032956.js";import{c as Pe}from"./capitalize-cfd5966b.js";import{u as Ne}from"./useSearchParam-ebfda256.js";import{u as Fe}from"./useDetailPageProps-fa80b790.js";import{u as $e}from"./usePersistItemDetail-b111bdde.js";import{A as Se}from"./index-9f4b88aa.js";const{TextArea:Me}=ue,we=re(new Date),Le={note:"",amount:0,mode:null,reference:"",refund_date:we},Ve=({url:o,loading:c,onSubmit:j,toggleModal:a,handleType:l})=>{var h,s,f;const[u]=I.useForm(),[y,r]=_.useState(!0),{details:t,paymentModes:i}=oe(o);return _.useEffect(()=>{var n,g;t!=null&&t.advancePayment&&Object.keys(t==null?void 0:t.advancePayment).length&&(u.setFieldsValue({...t.advancePayment,mode:(n=t==null?void 0:t.payment_methods[0])==null?void 0:n.value}),l((g=t==null?void 0:t.advancePayment)==null?void 0:g.type),r(!1))},[t==null?void 0:t.advancePayment]),y?e.jsx(q,{}):e.jsxs(I,{name:"refund-form",layout:"vertical",autoComplete:"off",onFinish:j,initialValues:Le,children:[e.jsxs(p,{children:[e.jsx(m,{children:e.jsx(ce,{isRequired:!0,label:"Refund Date",name:"refund_date"})}),e.jsx(m,{offset:1,span:4,children:e.jsx(I.Item,{label:"Amount",name:"amount",colon:!1,children:e.jsx(le,{min:1,name:"amount",addonAfter:(h=t==null?void 0:t.currency)==null?void 0:h.symbol,max:(s=t==null?void 0:t.advancePayment)==null?void 0:s.unused_amount,placeholder:`${(f=t==null?void 0:t.currency)==null?void 0:f.symbol}0.00`})})}),e.jsx(m,{offset:1,span:4,children:e.jsx(I.Item,{name:"mode",label:"Payment Mode",rules:ie({message:"Payment Mode Required"}),className:"flex_root",children:e.jsx(ke,{options:i,placeholder:"Select Payment Mode"})})}),e.jsx(m,{offset:1,children:e.jsx(de,{name:"reference",size:"middle",label:"Reference"})})]}),e.jsx(p,{children:e.jsx(m,{span:10,children:e.jsx(I.Item,{label:"Description",name:"note",className:"mb flex_root",children:e.jsx(Me,{rows:4,placeholder:"Description"})})})}),e.jsx(J,{}),e.jsxs(me,{className:"steps-action",children:[e.jsx(Y,{type:"default",btnText:"Cancel",htmlType:"button",clickHandler:a}),e.jsx(Y,{block:!0,btnText:"Create",style:{width:"120px"},loading:c})]})]})},Re=({url:o,loading:c,onSubmit:j,showModal:a,toggleModal:l,handleType:u,has_permission:y})=>e.jsx(e.Fragment,{children:e.jsx(xe,{width:1e3,footer:null,destroyOnClose:!0,open:a,onOk:l,style:{top:0},maskClosable:!1,onCancel:l,title:y&&"Add Refund",children:y?e.jsx(Ve,{url:o,loading:c,onSubmit:j,toggleModal:l,handleType:u}):e.jsx(ee,{})})}),{ADVANCE_REFUND:Oe,STORE:ze}=k,Ye=({url:o,PRdetail:c,showModal:j,toggleModal:a,refetchRefund:l,has_permission:u,refetchPaymentReceived:y})=>{const[r,t]=_.useState(""),{callAxios:i,toggle:h,bool:s}=$(),f=_.useCallback(g=>t(g),[]),n=g=>{h(),i({method:"post",url:`${Oe}${ze}`,data:{...g,type:r,advance_payment_id:c==null?void 0:c.id,refund_date:ye(g.refund_date)}}).then(A=>{A&&(Q({message:A.message}),a(),l(),y())})};return e.jsx(e.Fragment,{children:e.jsx(Re,{url:o,loading:s,onSubmit:n,showModal:j,handleType:f,toggleModal:a,has_permission:u})})},{Text:He}=D,{NAME:S,DELETE:Ue}=V,Be=({loading:o,url:c,fetchList:j,toggleModal:a,handleConfirm:l,has_permission:u})=>{const y=_.useMemo(()=>[{title:"Date Refunded",dataIndex:"refund_date",key:S,width:120,ellipsis:!0,render:r=>F(r)},{title:"Payment Mode",dataIndex:"mode",key:S,ellipsis:!0,width:200},{title:"Amount Credited",dataIndex:"",key:S,ellipsis:!0,width:120,render:r=>{var t,i;return e.jsxs(D,{children:[e.jsx(L,{placement:"topLeft",title:(t=r==null?void 0:r.currency)==null?void 0:t.name,children:e.jsx(He,{code:!0,children:(i=r==null?void 0:r.currency)==null?void 0:i.symbol})}),`${r.amount}`]})}},{title:"",dataIndex:"",width:50,key:"x",align:"center",render:r=>e.jsx(ne,{data:r,handleConfirm:l,canEdit:!1,deletePermission:u,title:u?`${Ue} Refund ?`:"Access Denied"})}],[u]);return e.jsx(e.Fragment,{children:e.jsx(ve,{url:c,bool:o,rowKey:"package_no",fetchList:j,columns:y,toggleModal:a})})},{ADVANCE_REFUND:B}=k,Ke=({url:o,PRdetail:c,fetchList:j,refetchRefund:a,refetchPaymentReceived:l})=>{const{checkPermission:u}=O(),{bool:y,toggle:r}=R(),{callAxios:t,toggle:i,bool:h}=$(),{has_InvoicePaymentRecordCreate_permission:s}=u("InvoicePaymentRecordCreate"),{has_InvoicePaymentRecordDelete_permission:f}=u("InvoicePaymentRecordDelete"),n=A=>{i(),t({method:"delete",url:`${B}/${A.id}`}).then(x=>{x&&(Q({message:x.message}),a(),l())})},g=_.useCallback(n,[a,l]);return e.jsxs(e.Fragment,{children:[e.jsx(Be,{url:o,loading:h,fetchList:j,toggleModal:r,handleConfirm:g,has_permission:f}),y&&e.jsx(Ye,{showModal:y,PRdetail:c,toggleModal:r,refetchRefund:a,refetchPaymentReceived:l,url:`${B}/${c==null?void 0:c.id}/create`,has_permission:s})]})},{VscClose:Ge}=X,{Title:b,Text:T}=D,{ADVANCE_PAYMENT:M,ACTIVITY_LOG:K,INVOICE_PAYMENT:qe,ADVANCE:Je,ADVANCE_REFUND:Qe}=k,We=({PRdetail:o,deleteItem:c,dataLength:j=0,handleFullScreen:a,refetchPaymentReceived:l})=>{var v,E;const{callAxios:u}=$(),y=H("tab_key"),[r,t]=_.useState(!0),{curr_id:i}=JSON.parse(H("obj")),{bool:h,setTrue:s,setFalse:f}=R(),[n,g]=_.useState();_.useEffect(()=>{(h||(!c||c&&j>1)&&Number(n==null?void 0:n.payment_no)!==i)&&u({url:`${M}/${(o==null?void 0:o.payment_no)||i}`}).then(d=>{g(d),t(!1),f()})},[o==null?void 0:o.payment_no,h,c,j,i]);const A=_.useMemo(()=>[{title:"Invoice No",dataIndex:"get_invoice",width:40,ellipsis:!0,render:d=>e.jsx(T,{children:d==null?void 0:d.invoice_no})},{title:"Invoice Date",dataIndex:"get_invoice",width:40,ellipsis:!0,render:d=>e.jsx(T,{children:F(d==null?void 0:d.invoice_date)})},{title:"Invoice Amount",dataIndex:"get_invoice",width:50,ellipsis:!0,render:d=>{var C;return e.jsx(U,{value:(d==null?void 0:d.total)||0,valueStyle:{fontSize:"13px"},prefix:(C=n==null?void 0:n.currency)==null?void 0:C.symbol})}},{title:"Payment Received",dataIndex:"get_invoice",width:50,ellipsis:!0,render:d=>{var C;return e.jsx(U,{value:(d==null?void 0:d.total)||0,valueStyle:{fontSize:"13px"},prefix:(C=n==null?void 0:n.currency)==null?void 0:C.symbol})}}],[(v=n==null?void 0:n.currency)==null?void 0:v.symbol]),x=_.useMemo(()=>[{key:"1",label:"History",children:e.jsx(e.Fragment,{children:n&&e.jsx(he,{url:(n==null?void 0:n.payment_type)==="advance"?`${M}/${n==null?void 0:n.id}${K}${Je}`:`${M}/${n==null?void 0:n.id}${K}${qe}`})})},{key:"2",label:"Refunds",children:e.jsx(e.Fragment,{children:n&&Object.keys(n).length>0&&e.jsx(Ke,{url:`${Qe}/${n==null?void 0:n.id}/list`,PRdetail:n,fetchList:h,refetchRefund:s,refetchPaymentReceived:l})})}],[n,h,s,l]);return e.jsx(e.Fragment,{children:r?e.jsx(q,{}):e.jsxs(e.Fragment,{children:[e.jsx(je,{title:`Payment No. ${n==null?void 0:n.payment_no}`,extra:[e.jsx(Ge,{size:20,onClick:()=>fe(a)},"close")],footer:e.jsx(e.Fragment,{children:e.jsx(ge,{items:x,onChange:_e,defaultActiveKey:y||"0"})})}),e.jsx(J,{}),e.jsxs(p,{children:[e.jsxs(m,{offset:1,children:[e.jsx(b,{level:4,style:{color:"green"},children:"PAYMENT DETAILS"}),e.jsx(b,{level:5,children:(E=n==null?void 0:n.customer)==null?void 0:E.display_name}),e.jsxs(b,{level:5,children:["Payment No. ",n==null?void 0:n.payment_no]}),e.jsx(W,{color:"blue",children:Pe(n==null?void 0:n.status)})]}),e.jsxs(m,{offset:7,children:[e.jsxs(p,{children:[e.jsx(m,{children:e.jsx(b,{level:5,children:"Date"})}),e.jsx(m,{style:{paddingLeft:"220px"},children:e.jsx(T,{children:F(n==null?void 0:n.payment_date)})})]}),e.jsxs(p,{children:[e.jsx(m,{children:e.jsx(b,{level:5,children:"Payment Mode"})}),e.jsx(m,{style:{paddingLeft:"140px"},children:e.jsx(T,{children:n==null?void 0:n.payment_mode})})]}),e.jsxs(p,{children:[e.jsx(m,{children:e.jsx(b,{level:5,children:"Total Amount"})}),e.jsx(m,{style:{paddingLeft:"150px"},children:e.jsx(T,{children:n==null?void 0:n.payment})})]}),e.jsxs(p,{children:[e.jsx(m,{children:e.jsx(b,{level:5,children:"Used Amount"})}),e.jsx(m,{style:{paddingLeft:"150px"},children:e.jsx(T,{children:((n==null?void 0:n.payment)||0)-((n==null?void 0:n.unused_amount)||0)})})]}),e.jsxs(p,{children:[e.jsx(m,{children:e.jsx(b,{level:5,children:"Balance"})}),e.jsx(m,{style:{paddingLeft:"190px"},children:e.jsx(T,{children:n==null?void 0:n.unused_amount})})]})]})]}),e.jsx(p,{children:e.jsx(m,{offset:1,children:e.jsx(pe,{bordered:!0,rowKey:"id",pagination:!1,columns:A,style:{marginTop:"8px"},dataSource:n==null?void 0:n.invoice_payments})})})]})})},{VscAdd:Xe}=X,{record_payment:Ze}=be,{NEW_PAYMENT_RECEIVED:en}=V,{ADD_PAYMENTS_RECEIVED:nn}=Z,tn=[{key:"filters",type:"group",label:"DEFAULT FILTERS",children:[]},{type:"divider"},{key:"10",label:"New Custom View",icon:e.jsx(Xe,{})}],sn=({enable:o=!1})=>e.jsx(e.Fragment,{children:e.jsx(Ae.SubHeader,{items:tn,enabled:o,title:Ze,btnText:en,navigateTo:nn})}),{ADVANCE_PAYMENT:an}=k,{Text:G}=D,{NAME:N,SYMBOL:rn,CODE:w,DELETE:on}=V,cn=({loading:o,refetch:c,listing:j,showDetail:a,handleClick:l,handleConfirm:u,bulkDeleteTrue:y,handleViewClick:r})=>{const{checkPermission:t}=O(),{has_InvoicePaymentRecordDelete_permission:i}=t("InvoicePaymentRecordDelete"),h=_.useMemo(()=>[{title:"Date",dataIndex:"payment_date",key:N,width:a?98:120,ellipsis:!0,render:s=>F(s)},{title:"Payment #",dataIndex:"payment_no",key:rn,width:a?0:100,ellipsis:!0},{title:"Refrence#",dataIndex:"reference",key:w,width:a?0:130,ellipsis:!0},{title:"Customer",dataIndex:"display_name",width:a?120:170,key:N,ellipsis:!0},{title:"Invoice#",dataIndex:"invoice_no",key:N,ellipsis:!0,width:a?0:130},{title:"Mode",dataIndex:"payment_mode",key:N,ellipsis:!0,width:a?0:110,render:s=>e.jsx(W,{autoCapitalize:"",color:"blue",children:s},s)},{title:"Amount",dataIndex:"",key:w,width:a?0:120,ellipsis:!0,render:s=>{var f,n;return e.jsxs(D,{children:[e.jsx(L,{placement:"topLeft",title:(f=s==null?void 0:s.currency)==null?void 0:f.name,children:e.jsx(G,{code:!0,children:(n=s==null?void 0:s.currency)==null?void 0:n.symbol})}),`${s.payment_made}`]})}},{title:"Balance",dataIndex:"",key:w,width:a?100:120,ellipsis:!0,render:s=>{var f,n;return e.jsxs(D,{children:[e.jsx(L,{placement:"topLeft",title:(f=s==null?void 0:s.currency)==null?void 0:f.name,children:e.jsx(G,{code:!0,children:(n=s==null?void 0:s.currency)==null?void 0:n.symbol})}),`${s.unused_amount}`]})}},{title:"",dataIndex:"",width:50,key:"x",align:"center",render:s=>e.jsx(ne,{data:s,handleClick:l,handleConfirm:u,canEdit:s.platform_type==="books",deletePermission:s.platform_type==="books"?i:!1,title:i&&s.platform_type==="books"?`${on} "${s.payment_no}" ?`:"Permission Denied"})}],[u,i,l,a]);return e.jsx(e.Fragment,{children:e.jsx(Ee,{paymentReceived:!0,refetch:c,loading:o,listing:j,columns:h,url:an,bulkDeleteTrue:y,handleViewClick:r})})},{ADVANCE_PAYMENT:ln}=k,{EDIT_PAYMENTS_RECEIVED:dn}=Z,bn=()=>{var z;const o=Ce(),{checkPermission:c}=O(),{getParams:j}=Ne(""),{bool:a,handleConfirm:l}=$(),{getCurrentModule:u,checkModulePermission:y}=Te(),{status:r=void 0}=u("payment-received")||{},{has_InvoicePaymentRecordView_permission:t}=c("InvoicePaymentRecordView"),{bool:i,setTrue:h,setFalse:s}=R(),{memoizeHandleClick:f,detail:n,fullScreen:g,handleFullScreen:A}=Fe(),{data:x,isLoading:v,refetch:E,isFetching:d}=De(j(),{refetchOnMountOrArgChange:!0,skip:!t||y("payment-received")}),{handleSessionState:C}=$e(A,s,i);_.useEffect(()=>{!d&&i&&C(x==null?void 0:x.advancePayments,"paymentreceived",!0)},[d,i,x==null?void 0:x.advancePayments]);const te=_.useCallback(P=>l(P,ln,E,h),[l,E,h]),se=P=>{Ie(P.payment_no,!0,"paymentreceived"),o(`${dn}?id=${P.payment_no}`)},ae=_.useCallback(se,[o]);return e.jsx(e.Fragment,{children:t?e.jsxs(e.Fragment,{children:[!r&&e.jsx(Se,{showIcon:!0,type:"info",message:"Module Permissions",description:"Please Enable Module Permissions To See Details"}),e.jsx(sn,{enable:!r}),e.jsxs(p,{children:[e.jsx(m,{span:g?10:24,children:(x==null?void 0:x.advancePayments)&&e.jsx(cn,{refetch:E,showDetail:g,handleClick:ae,bulkDeleteTrue:h,loading:a||v,listing:x.advancePayments,handleConfirm:te,handleViewClick:f})}),g&&e.jsx(e.Fragment,{children:e.jsx(m,{span:14,children:(x==null?void 0:x.advancePayments)&&e.jsx(We,{PRdetail:n,deleteItem:i,refetchPaymentReceived:E,handleFullScreen:A,dataLength:(z=x.advancePayments.data)==null?void 0:z.length})})})]})]}):e.jsx(ee,{})})};export{bn as default};
